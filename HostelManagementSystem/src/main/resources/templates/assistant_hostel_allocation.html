<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HMS-UOP_Assistant_Hostel_Allocation</title>
    <link rel="icon" href="images/Logo.png" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex h-screen">
<script src="/assistant.js"></script>

<div id="sidebar" class="w-52 bg-blue-100 text-gray-800 flex flex-col justify-between fixed lg:static left-0 top-0 h-full transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50">
    <div>
        <div class="p-4 flex items-center border-b border-blue-200 justify-center">
            <img src="images/logo.png" alt="Hostel Logo" class="w-20 h-20 object-contain border-none shadow-none outline-none" />
        </div>
        <div class="mt-3 px-4 space-y-3">
            <a href="/ExcelFileList" class="w-full py-2 bg-white text-black rounded-full font-semibold hover:bg-blue-300 flex items-center justify-start px-4 space-x-2 transition duration-200">
                <img src="images/Dashboard.svg" alt="Dashboard Icon" class="w-5 h-5" />
                <span>Dashboard</span>
            </a>
            <a href="/distance_calculation" class="w-full py-2 bg-white text-black rounded-full font-semibold hover:bg-blue-300 flex items-center justify-start px-4 space-x-2 transition duration-200">
                <img src="images/Distance.png" alt="Dashboard Icon" class="w-5 h-5" />
                <span>Distance</span>
            </a>
            <a href="/hostel_allocation" class="w-full py-2 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 flex items-center justify-start px-4 space-x-2 transition duration-200">
                <img src="images/Hostel2.png" alt="Dashboard Icon" class="w-5 h-5" />
                <span>Allocation</span>
            </a>
        </div>
    </div>
    <footer>
        <div class="text-center mb-6 px-4">
            <a href="/logout" class="w-full py-2 bg-white text-black rounded-full font-bold hover:bg-blue-400 focus:outline-none flex items-center justify-center space-x-2">
                <img src="images/LogOut.png" alt="Logout Icon" class="w-5 h-5 -rotate-90" />
                <span>Log Out</span>
            </a>
        </div>
    </footer>
</div>

<!-- Overlay for mobile -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

<!-- Main Content -->
<div class="flex-1 overflow-auto">
    <div class="container mx-auto p-6">

        <!-- Header Box -->
        <div class="bg-blue-200 rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center">
                <!-- Logo + Title Together -->
                <div class="flex items-center space-x-4">
                    <button id="toggle-btn" class="lg:hidden text-2xl">&#9776;</button>
                    <img src="images/UniversityLogo.png" alt="University Logo" class="w-12 h-12 object-contain border-none shadow-none outline-none" />
                    <h1 class="text-xl font-bold text-gray-800">HMS - UNIVERSITY OF PERADENIYA</h1>
                </div>

            </div>
        </div>

        <!-- STEP 1: Batch Selection -->
        <div class="bg-white rounded-lg shadow p-6 mb-6" >
            <form th:action="@{/loadBatch}" method="post">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Step 1: Select Batch for Hostel Allocation</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Faculty</label>
                        <select id="facultySelect" name="facultyId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Faculty</option>
                            <option value="engineering" th:each="faculty : ${faculties}" th:value="${faculty.id}" th:text="${faculty.name}">Engineering</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Intake</label>
                        <select id="intakeSelect" name="intakeId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 " >
                            <option value="">Select Intake</option>
                            <option value="2024" th:each="intake : ${intakes}" th:value="${intake.id}" th:text="${intake.intake}">2024</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                        <select id="genderSelect" name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" onclick="loadBatchData()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Load Batch
                        </button>
                    </div>
                </div>
            </form>
        </div>



        <!-- STEP 2: Distance Threshold -->
        <div id="thresholdSection" class="bg-white rounded-lg shadow p-6 mb-6 " th:if="${students != null and !students.isEmpty()}">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Step 2: Set Eligibility Criteria</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="flex items-center">
                            <input type="radio" name="criteriaType" value="distance" class="mr-2" checked>
                            <span class="text-sm font-medium text-gray-700">Set Minimum Distance Threshold</span>
                        </label>
                        <div class="mt-2 flex items-center space-x-2">
                            <input type="number" id="distanceThreshold" placeholder="Enter distance in km"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm text-gray-600">km</span>
                        </div>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="radio" name="criteriaType" value="count" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Select Top Students by Distance</span>
                        </label>
                        <div class="mt-2">
                            <input type="number" id="studentCount" placeholder="Number of students"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>


                </div>
                <input type="hidden" id="facultyId" name="facultyId" th:value="${facultyId}">
                <input type="hidden" id="intakeId" name="intakeId" th:value="${intakeId}">
                <input type="hidden" id="gender" name="gender" th:value="${gender}">
                <div class="flex items-center justify-center">
                    <button onclick="applyFilter()" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        Apply Filter
                    </button>
                </div>
            </div>
            <div id="filteredCount" class="mt-4 p-3 bg-gray-100 rounded-md hidden">
                <p class="text-sm text-gray-700">Filtered Students: <span id="filteredStudentCount" class="font-semibold">0</span></p>
            </div>
        </div>


        <!-- STEP 3: Hostel Availability Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Step 3: Hostel Availability Overview</h2>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="showHostelTab('fully-available')" id="tab-fully" class="hostel-tab py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                        Fully Available Rooms
                    </button>
                    <button onclick="showHostelTab('partially-available')" id="tab-partially" class="hostel-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Partially Available Rooms
                    </button>
                </nav>
            </div>


            <!-- Fully Available Hostels Tab -->
            <div id="fully-available" class="hostel-content mt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="hostel-card border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer"
                         th:each="hostel : ${fullyAvailableHostels}" th:onclick="selectHostel([[${hostel.id}]], [[${hostel.name}]])">
                        <h3 class="font-semibold text-gray-800" th:text="${hostel.name}">Hostel A</h3>
                        <p class="text-sm text-gray-600">Available Rooms: <span class="font-medium" th:text="${hostel.availableRooms}">15</span></p>
                        <p class="text-sm text-gray-600">Capacity: <span class="font-medium" th:text="${hostel.totalCapacity}">60</span> students</p>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" th:style="'width: ' + ${hostel.availabilityPercentage} + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Partially Available Hostels Tab -->
            <div id="partially-available" class="hostel-content mt-4 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="hostel-card border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer"
                         th:each="hostel : ${partiallyAvailableHostels}" onclick="selectHostel(${hostel.id}, ${hostel.name})">
                        <h3 class="font-semibold text-gray-800" th:text="${hostel.name}">Hostel B</h3>
                        <p class="text-sm text-gray-600">Available Spaces: <span class="font-medium" th:text="${hostel.availableRooms}">8</span></p>
                        <p class="text-sm text-gray-600">Total Capacity: <span class="font-medium" th:text="${hostel.totalCapacity}">40</span> students</p>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-600 h-2 rounded-full" th:style="'width: ' + ${hostel.availabilityPercentage} + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- STEP 4 & 5: Student Selection and Allocation -->
        <div id="allocationSection" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Step 4 & 5: Student Selection for <span id="selectedHostelName" class="text-blue-600"></span></h2>
                <button onclick="cancelAllocation()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                    Cancel
                </button>
            </div>

            <!-- Sorting Controls -->
            <div class="flex items-center space-x-4 mb-4">
                <label class="text-sm font-medium text-gray-700">Sort by:</label>
                <select id="sortBy" onchange="sortStudentList()" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="distance">Distance (Longest to Shortest)</option>
                    <option value="studentId">Registration Number</option>
                </select>
            </div>

            <!-- Set Academic year -->
            <div class="flex items-center space-x-4 mb-4">
                <label class="text-sm font-medium text-gray-700">Academic Year:</label>
                <select id="academicYear" onchange="removeAllocated()" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="1">Select Year</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>

            <!-- Selection Summary -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" >
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-600">Selected Students</p>
                        <p id="selectedCount" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Available Spaces</p>
                        <p id="availableSpaces" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Remaining</p>
                        <p id="remainingSpaces" class="text-2xl font-bold text-gray-600">0</p>
                    </div>
                </div>
            </div>

            <!-- Student List -->
            <div class="border border-gray-200 rounded-lg">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex items-center">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-3">
                        <label for="selectAll" class="text-sm font-medium text-gray-700">Select All</label>
                    </div>
                </div>
                <div id="studentList" class="max-h-96 overflow-y-auto">
                    <!-- Student list will be populated by JavaScript -->
                </div>
            </div>

            <!-- Submit Button -->
            <div class="mt-6 text-center">
                <button onclick="submitAllocation()" id="submitBtn" disabled
                        class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Allocate Selected Students
                </button>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="hidden">
            <!-- Messages will be inserted here -->
        </div>



    </div>
</div>


<script>

    // Global variables
    let selectedHostel = null;
    let filteredStudents = [];
    let selectedStudents = new Set();

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-btn');
    const overlay = document.getElementById('overlay');

    toggleBtn.addEventListener('click', () => {
        const isOpen = !sidebar.classList.contains('-translate-x-full');

        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden', isOpen);
    });

    overlay.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    });

    // Step 1: Load batch data
    function loadBatchData() {
        const faculty = document.getElementById('facultySelect').value;
        const intake = document.getElementById('intakeSelect').value;
        const gender = document.getElementById('genderSelect').value;

        if (!facultyId || !intakeId || !gender) {
            showMessage('Please select all batch criteria', 'error');
            return;
        }
        alert("function is called");
        // Show threshold section
        document.getElementById('thresholdSection').classList.remove('hidden');
        showMessage('Batch loaded successfully. Please set eligibility criteria.', 'success');
    }




    // Cancel allocation
    function cancelAllocation() {
        selectedHostel = null;
        selectedStudents.clear();
        document.getElementById('allocationSection').classList.add('hidden');
        showMessage('Allocation cancelled', 'info');
    }

    // Show message
    function showMessage(message, type) {
        const container = document.getElementById('messageContainer');
        const messageDiv = document.createElement('div');

        let bgColor = 'bg-blue-100';
        let textColor = 'text-blue-800';
        let borderColor = 'border-blue-200';

        if (type === 'success') {
            bgColor = 'bg-green-100';
            textColor = 'text-green-800';
            borderColor = 'border-green-200';
        } else if (type === 'error') {
            bgColor = 'bg-red-100';
            textColor = 'text-red-800';
            borderColor = 'border-red-200';
        }

        messageDiv.className = `${bgColor} ${borderColor} ${textColor} px-4 py-3 rounded-lg border mb-4`;
        messageDiv.textContent = message;

        container.innerHTML = '';
        container.appendChild(messageDiv);
        container.classList.remove('hidden');

        // Auto hide after 5 seconds
        setTimeout(() => {
            container.classList.add('hidden');
        }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        showHostelTab('fully-available');
    });

</script>


</body>
</html>
